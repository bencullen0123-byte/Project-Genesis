ðŸš€ SPRINT 9.9.1: DASHBOARD ISOLATION (The Final Polish)
Task: Scope the Dashboard queries to the merchantId.

1. Update server/storage.ts Replace getRecentTasks and getDashboardStats with these tenant-scoped versions:

TypeScript

  // server/storage.ts

  // 1. Scope Recent Tasks
  async getRecentTasks(merchantId: string, limit: number = 10): Promise<ScheduledTask[]> {
    return db.select().from(scheduledTasks)
      .where(eq(scheduledTasks.merchantId, merchantId)) // <--- ADDED SCOPE
      .orderBy(desc(scheduledTasks.createdAt))
      .limit(limit);
  }

  // 2. Scope Dashboard Stats
  async getDashboardStats(merchantId: string) {
    // Remove global merchant count (users shouldn't know how many other users exist)
    
    const [pendingCount] = await db.select({ count: sql<number>`count(*)::int` })
      .from(scheduledTasks)
      .where(and(
        eq(scheduledTasks.status, TaskStatus.PENDING),
        eq(scheduledTasks.merchantId, merchantId) // <--- SCOPED
      ));

    const [runningCount] = await db.select({ count: sql<number>`count(*)::int` })
      .from(scheduledTasks)
      .where(and(
        eq(scheduledTasks.status, TaskStatus.RUNNING),
        eq(scheduledTasks.merchantId, merchantId) // <--- SCOPED
      ));

    const [totalRecovered] = await db.select({ 
      total: sql<number>`COALESCE(sum(recovered_cents), 0)::int` 
    })
    .from(dailyMetrics)
    .where(eq(dailyMetrics.merchantId, merchantId)); // <--- SCOPED

    // ... (Repeat scoping for successStats and rateStats using merchantId) ...

    return {
      totalRecovered: totalRecovered?.total || 0,
      activeMerchants: 1, // You are the only active merchant in your view
      pendingTasks: pendingCount?.count || 0,
      runningTasks: runningCount?.count || 0,
      // ... keep existing return structure
    };
  }
2. Update server/routes.ts Pass the req.merchant.id to these methods in the dashboard route.

TypeScript

  // server/routes.ts (Lines ~25)
  app.get("/api/dashboard", requireAuth(), requireMerchant, async (req, res) => {
    try {
      const merchant = req.merchant!;
      // PASS MERCHANT ID
      const stats = await storage.getDashboardStats(merchant.id); 
      const recentTasks = await storage.getRecentTasks(merchant.id, 5); 
      // ...