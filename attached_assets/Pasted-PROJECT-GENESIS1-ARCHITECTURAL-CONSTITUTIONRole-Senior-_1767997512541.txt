PROJECT GENESIS1. ARCHITECTURAL CONSTITUTIONRole: Senior Backend Architect.Project: "The Citadel" â€” A Multi-Tenant, Headless Stripe Recovery Engine.Core Architecture: Modular Monolith using PostgreSQL as the State Machine.Operational Constraints (Non-Negotiable):Transactional Integrity: All business logic is driven by the database state. Do not use in-memory queues or setTimeout.Concurrency: All job queues must utilize SELECT FOR UPDATE SKIP LOCKED to prevent race conditions.Isolation: Multi-tenancy is enforced via a "Client Factory" pattern. No global Stripe instances.Privacy: Zero PII. Store only Stripe IDs (cus_..., sub_...).Reliability: Use the "Two-Phase" processing model (Lock -> I/O -> Complete) to protect DB connections.2. THE FEATURE MANIFEST (SCOPE)You are to build the following 4 distinct modules:Module A: The Foundation (Schema & Auth)Database: Initialize the 5-table PostgreSQL schema (Merchants, Tasks, Usage, Events, Metrics).Maintenance: Apply autovacuum_vacuum_scale_factor = 0.01 to the scheduled_tasks table.Auth: Implement /auth/stripe (Connect OAuth) with signed state tokens.Module B: The Heartbeat (Worker Engine)The Worker: A node-cron job running the Two-Phase loop (SKIP LOCKED -> Stripe API -> Commit).The Factory: lib/stripe.js must inject the Stripe-Account header for every request based on tenant_id.Module C: The Ingress (Webhooks)Secure Pipe: /webhooks/stripe with signature verification against the Platform Secret.Routing: Logic to route events based on billing_reason (e.g., specific handling for subscription_cycle failures).Module D: The Ledger (Analytics)Shadow Ledger: Dual-write logic for usage tracking (Local DB + Async Stripe Job).God Mode: Trigger-based accounting (AFTER INSERT triggers) for $O(1)$ dashboard stats.3. EXECUTION STEP 1: INITIALIZATIONAction: Initialize the project with express, pg, and dotenv.Task: Execute the following SQL Schema strictly. Do not modify table names.SQL-- 1. TENANT REGISTRY (Identity)
CREATE TABLE merchants (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    stripe_connect_id TEXT UNIQUE NOT NULL,
    stripe_user_id TEXT, -- Critical for OAuth linkage
    access_token TEXT, -- Encrypted at rest
    tier TEXT DEFAULT 'FREE', 
    created_at TIMESTAMP DEFAULT NOW()
);

-- 2. THE QUEUE (State Machine)
CREATE TABLE scheduled_tasks (
    id SERIAL PRIMARY KEY,
    merchant_id TEXT NOT NULL,
    task_type TEXT NOT NULL,
    payload JSONB NOT NULL,
    status TEXT DEFAULT 'pending', 
    run_at TIMESTAMP DEFAULT NOW(),
    created_at TIMESTAMP DEFAULT NOW()
);

-- 3. THE LEDGER (Shadow Copy for UI)
CREATE TABLE usage_logs (
    id SERIAL PRIMARY KEY,
    merchant_id TEXT NOT NULL,
    metric_type TEXT NOT NULL,
    amount INT DEFAULT 1,
    created_at TIMESTAMP DEFAULT NOW()
);

-- 4. EVENT HISTORIAN (Idempotency)
CREATE TABLE processed_events (
    event_id TEXT PRIMARY KEY,
    processed_at TIMESTAMP DEFAULT NOW()
);

-- 5. ANALYTICS (Materialized View)
CREATE TABLE daily_metrics (
    merchant_id TEXT NOT NULL,
    metric_date DATE DEFAULT CURRENT_DATE,
    recovered_cents BIGINT DEFAULT 0,
    PRIMARY KEY (merchant_id, metric_date)
);
Output Requirement:Confirm the Schema is executed.Confirm the ALTER TABLE command for autovacuum was run.Stop and await instruction for Module A (Auth).