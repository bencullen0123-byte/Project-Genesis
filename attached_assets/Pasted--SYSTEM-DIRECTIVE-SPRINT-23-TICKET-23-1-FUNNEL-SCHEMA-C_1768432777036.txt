ðŸš¨ SYSTEM DIRECTIVE: SPRINT 23 - TICKET 23.1 (FUNNEL SCHEMA)
CONTEXT: We need to measure the effectiveness of our dunning sequences. This requires storing interaction timestamps on individual logs and aggregate metrics on a daily basis.

OBJECTIVE: Update shared/schema.ts to support interaction tracking.

ACTION PLAN
Target File: shared/schema.ts

Step 1: Update the usageLogs table Add the tracking timestamps to store the exact moment a customer interacts with an email.

TypeScript

// shared/schema.ts

export const usageLogs = pgTable("usage_logs", {
  id: serial("id").primaryKey(),
  merchantId: text("merchant_id")
    .notNull()
    .references(() => merchants.id, { onDelete: "cascade" }),
  metricType: text("metric_type").notNull(),
  amount: integer("amount").default(1).notNull(),
  
  // TRACKING TIMESTAMPS (Ticket 23.1)
  openedAt: timestamp("opened_at"),
  clickedAt: timestamp("clicked_at"),
  
  createdAt: timestamp("created_at").defaultNow().notNull(),
  reportedAt: timestamp("reported_at"),
}, (table) => [
  index("idx_usage_merchant_metric").on(table.merchantId, table.metricType),
  index("idx_usage_reported").on(table.reportedAt),
]);
Step 2: Update the dailyMetrics table Add pre-aggregated counters to store daily totals for opens and clicks.

TypeScript

// shared/schema.ts

export const dailyMetrics = pgTable("daily_metrics", {
  merchantId: text("merchant_id")
    .notNull()
    .references(() => merchants.id, { onDelete: "cascade" }),
  metricDate: date("metric_date").defaultNow().notNull(),
  recoveredCents: bigint("recovered_cents", { mode: "number" }).default(0).notNull(),
  emailsSent: integer("emails_sent").default(0).notNull(),
  
  // ANALYTICS COUNTERS (Ticket 23.1)
  totalOpens: integer("total_opens").default(0).notNull(),
  totalClicks: integer("total_clicks").default(0).notNull(),
}, (table) => [
  primaryKey({ columns: [table.merchantId, table.metricDate] }),
]);
Step 3: Apply Migrations Run the following in the Replit shell to synchronize the database with your new code: npm run db:push

VERIFICATION:

Schema Check: Verify the usage_logs table now includes opened_at and clicked_at.

Schema Check: Verify the daily_metrics table now includes total_opens and total_clicks.

Stability: Ensure the server restarts successfully after the migration.