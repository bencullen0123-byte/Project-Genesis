ðŸš¨ SYSTEM DIRECTIVE: SPRINT 9.9 - PHASE 3 (PERIMETER LOCKDOWN)CONTEXT:We have successfully secured the webhook engine. Now we must secure the API Surface.Currently, the Task API allows any user to view or manipulate any task if they guess the ID or query the list. This is a critical IDOR Vulnerability.OBJECTIVE:Refactor storage.ts and routes.ts to strictly enforce "Tenant Isolation" on all Task operations.TASK 1: Update Storage Layer (server/storage.ts)Action: Modify the getTasks method to require a merchantId. We must stop supporting "global" queries.Update Interface IStorage:Change: getTasks(status?: string) $\to$ getTasks(merchantId: string, status?: string)Update Implementation DatabaseStorage:TypeScript// server/storage.ts

async getTasks(merchantId: string, status?: string): Promise<ScheduledTask[]> {
  if (status && status !== "all") {
    return db.select().from(scheduledTasks)
      .where(and(
        eq(scheduledTasks.merchantId, merchantId), // SECURE: Filter by Owner
        eq(scheduledTasks.status, status)
      ))
      .orderBy(desc(scheduledTasks.createdAt));
  }
  // SECURE: Filter by Owner
  return db.select().from(scheduledTasks)
    .where(eq(scheduledTasks.merchantId, merchantId))
    .orderBy(desc(scheduledTasks.createdAt));
}
TASK 2: Secure the Routes (server/routes.ts)Action: Update all Task endpoints to enforce ownership.Secure the List (GET /api/tasks):Pass the authenticated merchant's ID to the new storage method.const tasks = await storage.getTasks(req.merchant!.id, status);Secure Single Task Operations:Targets: GET /api/tasks/:id, POST /api/tasks/:id/retry, DELETE /api/tasks/:idLogic: You must fetch the task, then CHECK OWNERSHIP before proceeding.Code Pattern (Apply to all 3 routes):TypeScriptconst id = parseInt(req.params.id);
const task = await storage.getTask(id);

if (!task) return res.status(404).json({ error: "Task not found" });

// ðŸ›‘ SECURITY GATE
if (task.merchantId !== req.merchant!.id) {
  return res.status(403).json({ error: "Forbidden" });
}

// Proceed with response, retry, or delete...
VERIFICATION:GET /api/tasks must only return tasks belonging to the logged-in user.GET /api/tasks/123 (where 123 belongs to another user) must return 403 Forbidden.