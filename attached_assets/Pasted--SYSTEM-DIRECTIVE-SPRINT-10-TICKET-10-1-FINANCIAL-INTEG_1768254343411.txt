ðŸš¨ SYSTEM DIRECTIVE: SPRINT 10 - TICKET 10.1 (FINANCIAL INTEGRITY)
CONTEXT: We have a critical "Take Money, Give Nothing" bug. The application currently ignores Stripe's customer.subscription.updated event. When a user upgrades from Free to Pro, Stripe charges them, but our database leaves them on price_free. This guarantees chargebacks.

OBJECTIVE: Update the webhook handler to listen for subscription changes and sync the new Plan ID to the database immediately.

ACTION PLAN
Target File: server/webhookHandlers.ts

Step 1: Add the Handler Logic Paste this new function at the bottom of the file (outside the main handler):

TypeScript

// SYNC PLAN UPDATES (The Fix for Ticket 10.1)
async function handleSubscriptionUpdated(event: Stripe.Event): Promise<WebhookResult> {
  const subscription = event.data.object as Stripe.Subscription;
  const stripeConnectId = event.account;

  if (!stripeConnectId) {
    return { 
      processed: true, 
      action: 'error', 
      reason: 'No Stripe Connect account ID - cannot sync plan' 
    };
  }

  try {
    // 1. Identify the Merchant
    const factory = await getStripeClientFactory();
    const { merchantId } = await factory.getClientByConnectId(stripeConnectId);

    // 2. Extract the New Plan ID (Price ID)
    // We assume the first item is the main subscription plan
    const priceId = subscription.items.data[0]?.price.id;

    if (!priceId) {
      return { 
        processed: true, 
        action: 'ignored', 
        reason: 'No price ID found in subscription items' 
      };
    }

    // 3. Update the Database
    await storage.updateMerchant(merchantId, {
      subscriptionPlanId: priceId 
    });

    return { 
      processed: true, 
      action: 'processed', 
      reason: `Merchant plan synced to ${priceId}` 
    };

  } catch (err: any) {
    return { 
      processed: false, // Retry this if it fails
      action: 'error', 
      reason: `Failed to sync plan update: ${err.message}` 
    };
  }
}
Step 2: Wire it into the Switch Update the handleStripeWebhook function's switch statement to include the new cases:

TypeScript

  // ... inside handleStripeWebhook switch statement ...

    case 'invoice.payment_failed':
      return handleInvoicePaymentFailed(event);
    
    // NEW CASES FOR TICKET 10.1
    case 'customer.subscription.updated':
    case 'customer.subscription.created':
      return handleSubscriptionUpdated(event);
    
    case 'invoice.payment_action_required':
      return handlePaymentActionRequired(event);

  // ... rest of switch
VERIFICATION: After this change, a customer.subscription.updated event must result in the merchants table updating the subscription_plan_id column for that user.