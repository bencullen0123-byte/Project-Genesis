SYSTEM DIRECTIVE: SPRINT 6 (SECURITY & RELIABILITY)
Objective: Implement field-level encryption, financial idempotency, and operational resilience. Execution Mode: overwrite / create.

Task 1: The Vault (Encryption)
File: Create server/lib/encryption.ts Action: Implement AES-256-GCM encryption utility. Requirements:

Use crypto module.

Key source: process.env.ENCRYPTION_KEY (Fallback to random bytes with console.warn if missing).

Algorithm: aes-256-gcm.

Export functions:

encrypt(text: string): string (Returns iv:authTag:encryptedContent)

decrypt(text: string): string

Task 2: Storage Hardening
File: server/storage.ts Action: Integrate encryption into the Data Access Layer. Requirements:

Import encrypt and decrypt from ./lib/encryption.

Write Operations (createMerchant, updateMerchant): Apply encrypt() to accessToken and refreshToken before saving to DB.

Read Operations (getMerchant, getMerchantByStripeUserId): Apply decrypt() to accessToken and refreshToken before returning the object.

Task 3: Financial Integrity (Idempotency)
File: server/worker.ts Action: Prevent double-billing on network retries. Requirements:

Locate all Stripe mutation calls (e.g., stripe.subscriptions.create, stripe.invoices.pay).

Add the idempotencyKey option to the Stripe config object for these calls.

Value: Use task_${task.id} (The task.id is the durable nonce).

Task 4: Operational Resilience
Sub-Task 4.1: Graceful Shutdown

File: server/index.ts

Action: Add process.on('SIGTERM') and process.on('SIGINT').

Logic:

Log shutdown signal.

server.close() to stop accepting new connections.

process.exit(0) after close.

Sub-Task 4.2: Database Indexes

File: Create migrations/0002_add_indexes.sql

Content:

SQL

CREATE INDEX IF NOT EXISTS idx_scheduled_tasks_status_run_at ON scheduled_tasks (status, run_at);
CREATE INDEX IF NOT EXISTS idx_merchants_stripe_connect_id ON merchants (stripe_connect_id);
Verification:

Restart server.

Verify no crash on startup (Encryption key warning is acceptable in Dev).

Verify migrations/0002_add_indexes.sql exists.