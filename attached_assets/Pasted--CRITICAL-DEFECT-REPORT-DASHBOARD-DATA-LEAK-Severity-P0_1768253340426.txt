ðŸš¨ CRITICAL DEFECT REPORT: DASHBOARD DATA LEAK
Severity: P0 (Launch Blocker) Status: FAILED Summary: The Dashboard logic violates Multi-Tenancy. It calculates statistics based on the entire database rather than the authenticated user.

DEFECT 1: The "God Mode" Statistics
What is Wrong: The getDashboardStats method aggregates data globally. When User A logs in, they see the total revenue and total task count for the entire platform (User A + User B + User C). This is a massive competitive intelligence leak.

Where it is Wrong: server/storage.ts

Code: db.select({ count: ... }).from(merchants) counts all rows in the table.

Code: db.select({ total: ... }).from(dailyMetrics) sums revenue for every merchant in existence.

The Resolution:

The method signature must change to getDashboardStats(merchantId: string).

Every single SQL query inside this function must include a .where(eq(table.merchantId, merchantId)) clause.

Specifically: Remove the merchantCount query entirely (a user doesn't need to know how many other users you have).

DEFECT 2: The "Global Feed" Leak
What is Wrong: The getRecentTasks method returns the 10 most recent tasks created by anyone in the system.

Where it is Wrong: server/storage.ts

Code: db.select().from(scheduledTasks).orderBy(...).limit(10) lacks a filter.

The Resolution:

The method signature must change to getRecentTasks(merchantId: string, limit: number).

The query must apply .where(eq(scheduledTasks.merchantId, merchantId)) before the limit is applied.

DEFECT 3: The Broken Wiring (Route Layer)
What is Wrong: Even if we fixed the storage layer, the API route is calling these functions without context. It is currently asking for "The Stats" instead of "My Stats."

Where it is Wrong: server/routes.ts (Inside GET /api/dashboard)

Current: const stats = await storage.getDashboardStats();

Current: const recentTasks = await storage.getRecentTasks(5);

The Resolution:

You must retrieve the authenticated merchant ID (req.merchant!.id) and pass it into both function calls.

EXECUTION PLAN FOR REPLIT
Direct the agent to perform these exact steps:

Refactor server/storage.ts:

Modify getRecentTasks to require merchantId and filter by it.

Modify getDashboardStats to require merchantId and scope all 5 sub-queries (pending, running, recovered, success rate, processing rate) to that ID.

Update server/routes.ts:

In GET /api/dashboard, pass req.merchant!.id to the updated getDashboardStats and getRecentTasks methods.

Do not deploy until these specific lines are corrected.