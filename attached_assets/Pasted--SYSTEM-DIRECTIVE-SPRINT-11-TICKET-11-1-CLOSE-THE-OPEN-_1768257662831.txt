ðŸš¨ SYSTEM DIRECTIVE: SPRINT 11 - TICKET 11.1 (CLOSE THE OPEN DOORS)
CONTEXT: We have two "Kill Chain" vulnerabilities:

Global Nuke: DELETE /api/tasks/completed is unauthenticated and global. Anyone can wipe the DB.

Worker Hijack: /api/worker/* endpoints are public. Anyone can claim/corrupt tasks.

OBJECTIVE: Secure these endpoints immediately with Authentication and Scope.

ACTION PLAN
Step 1: Secure the Storage Layer (server/storage.ts)

Goal: Force deleteCompletedTasks to require a merchantId.

Action: Update the interface and implementation.

TypeScript

// server/storage.ts

  // 1. Update Interface IStorage
  // Change: deleteCompletedTasks(): Promise<number>;
  // To:
  deleteCompletedTasks(merchantId: string): Promise<number>;

  // 2. Update DatabaseStorage Class
  async deleteCompletedTasks(merchantId: string): Promise<number> {
    const result = await db.delete(scheduledTasks)
      .where(and(
        eq(scheduledTasks.status, 'completed'),
        eq(scheduledTasks.merchantId, merchantId) // <--- CRITICAL FIX: Scoped to user
      ))
      .returning();
    return result.length;
  }
Step 2: Secure the API Routes (server/routes.ts)

Goal: Add authentication guards.

Action: Add requireWorkerAuth middleware and update the routes.

TypeScript

// server/routes.ts

  // --- ADD THIS HELPER MIDDLEWARE ---
  const requireWorkerAuth = (req: any, res: any, next: any) => {
    const secret = process.env.WORKER_SECRET;
    if (!secret) {
      // Fail secure if env var is missing
      log("Worker secret not configured", "security", "error"); 
      return res.status(500).json({ error: "Server configuration error" });
    }
    
    if (req.headers['x-worker-secret'] !== secret) {
      log(`Unauthorized worker access attempt from ${req.ip}`, "security", "warn");
      return res.status(403).json({ error: "Forbidden" });
    }
    next();
  };

  // --- UPDATE THE NUKE ROUTE (Line ~150) ---
  // Old: app.delete("/api/tasks/completed", async (req, res) => ...
  // New:
  app.delete("/api/tasks/completed", requireAuth(), requireMerchant, async (req, res) => {
    try {
      // PASS THE ID:
      const count = await storage.deleteCompletedTasks(req.merchant!.id);
      res.json({ deleted: count });
    } catch (error) {
      log(`Delete completed tasks error: ${error}`, 'routes', 'error');
      res.status(500).json({ error: "Failed to delete completed tasks" });
    }
  });

  // --- UPDATE WORKER ROUTES (Line ~200) ---
  // Old: app.post("/api/worker/claim", async (req, res) => ...
  // New:
  app.post("/api/worker/claim", requireWorkerAuth, async (req, res) => {
    try {
      const task = await storage.claimNextTask();
      if (!task) return res.json({ task: null });
      res.json({ task });
    } catch (error) {
      log(`Claim task error: ${error}`, 'routes', 'error');
      res.status(500).json({ error: "Failed to claim task" });
    }
  });

  app.post("/api/worker/complete/:id", requireWorkerAuth, async (req, res) => {
    try {
      // ... (keep existing logic) ...
      // Just ensure the route starts with requireWorkerAuth
      const id = parseInt(req.params.id);
      // ...
VERIFICATION:

Test Nuke: Try curl -X DELETE /api/tasks/completed without login. Expect 401/403.

Test Worker: Try curl -X POST /api/worker/claim. Expect 403 Forbidden.

Test Config: Ensure WORKER_SECRET is set in your .env.