ðŸš¨ SYSTEM DIRECTIVE: SPRINT 10 - TICKET 10.3 (GDPR COMPLIANCE)
CONTEXT: Our current "Right to Erasure" implementation is a legal liability. The function deletePendingTasks only removes tasks that haven't run yet. It leaves behind completed and failed tasks. These historical records contain the JSON payloads (Customer Emails, Names, Invoice IDs) of the merchant's customers. If a merchant asks to be deleted, we are currently lying to them by retaining their PII.

OBJECTIVE: Implement a true "Hard Delete" that wipes absolutely everything associated with a merchant ID from the tasks table.

ACTION PLAN
Step 1: Upgrade the Storage Layer (server/storage.ts) We need a nuclear option for the tasks table.

Update Interface IStorage:

TypeScript

// Add this line
deleteAllTasksForMerchant(merchantId: string): Promise<number>;
Update Class DatabaseStorage:

TypeScript

// Add this implementation
async deleteAllTasksForMerchant(merchantId: string): Promise<number> {
  const result = await db.delete(scheduledTasks)
    .where(eq(scheduledTasks.merchantId, merchantId)) // <--- NO STATUS FILTER. DELETE ALL.
    .returning();
  return result.length;
}
Step 2: Update the Admin Route (server/routes.ts) Update the deletion handler to use the new method.

Target: app.delete("/api/admin/merchants/:id", ...)

Logic:

TypeScript

// server/routes.ts

app.delete("/api/admin/merchants/:id", async (req, res) => {
  // ... (keep auth checks for admin key) ...

  const merchantId = req.params.id;

  try {
    const merchant = await storage.getMerchant(merchantId);
    if (!merchant) {
      return res.status(404).json({ error: 'Not Found', message: 'Merchant not found' });
    }

    // --- THE FIX STARTS HERE ---
    // 1. Delete ALL tasks (pending, completed, failed)
    const deletedTasks = await storage.deleteAllTasksForMerchant(merchantId);

    // 2. Delete Usage Logs
    const deletedLogs = await storage.deleteUsageLogs(merchantId);

    // 3. Delete The Merchant Account
    await storage.deleteMerchant(merchantId);
    // --- THE FIX ENDS HERE ---

    log(`GDPR Erasure executed for merchant ${merchantId} (tasks: ${deletedTasks}, logs: ${deletedLogs})`, 'admin');

    res.json({ 
      success: true, 
      message: 'Merchant data permanently erased',
      deleted: {
        tasks: deletedTasks,
        usageLogs: deletedLogs
      }
    });
  } catch (error: any) {
    log(`GDPR erasure failed for merchant ${merchantId}: ${error.message}`, 'admin', 'error');
    res.status(500).json({ error: 'Internal Server Error', message: 'Failed to erase merchant data' });
  }
});
VERIFICATION:

Insert a task with status 'completed' for a test merchant.

Call DELETE /api/admin/merchants/:id.

Verify the database returns 0 rows for that merchant in scheduled_tasks. (Previously it would have returned 1).